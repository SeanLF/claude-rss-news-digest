#!/bin/bash
# Deploy news-digest infrastructure
# Usage: bin/deploy [--skip-build] [-y|--yes]
#
# Builds and pushes Docker images, then applies Terraform
#
# Options:
#   --skip-build  Skip Docker image build/push
#   -y, --yes     Skip confirmation prompt
#
# Required environment variables:
#   REGISTRY - Docker registry URL (e.g., registry.example.com:5000)
#
# Optional (defaults from .env):
#   INFRA_DIR - Path to seanfloyd.dev infrastructure repo

set -e

# Load config from .env
if [ -f .env ]; then
  source .env
fi

SKIP_BUILD=false
AUTO_APPROVE=false
for arg in "$@"; do
  case $arg in
    --skip-build) SKIP_BUILD=true ;;
    -y|--yes) AUTO_APPROVE=true ;;
  esac
done

if [ -z "$REGISTRY" ]; then
  echo "Error: REGISTRY environment variable not set"
  echo "Example: export REGISTRY=registry.example.com:5000"
  exit 1
fi

INFRA_DIR="${INFRA_DIR:-../seanfloyd.dev}"
if [ ! -x "$INFRA_DIR/bin/tf" ]; then
  echo "Error: Infrastructure not found at $INFRA_DIR/bin/tf"
  exit 1
fi

# Ensure Tailscale is running
if ! tailscale status &> /dev/null; then
  echo "Starting Tailscale..."
  open -a Tailscale
  for i in {1..30}; do
    tailscale status &> /dev/null && break
    sleep 1
  done
fi

# Build and push images
if [ "$SKIP_BUILD" = "false" ]; then
  echo "Building digest-server..."
  docker buildx build --platform linux/amd64 -t "$REGISTRY/digest-server:latest" ./digest-server

  echo "Pushing digest-server..."
  docker push "$REGISTRY/digest-server:latest"

  echo "Building news-digest..."
  docker buildx build --platform linux/amd64 -t "$REGISTRY/news-digest:latest" .

  echo "Pushing news-digest..."
  docker push "$REGISTRY/news-digest:latest"
fi

# Confirm before applying Terraform
echo ""
echo "About to apply Terraform to:"
echo "  - null_resource.news_digest_env"
echo "  - null_resource.digest_server"
echo ""

if [ "$AUTO_APPROVE" = "false" ]; then
  read -p "Continue? [y/N] " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 1
  fi
fi

# Apply Terraform (secrets loaded from 1Password via bin/tf)
echo "Applying Terraform..."
"$INFRA_DIR/bin/tf" apply -target=null_resource.news_digest_env \
                          -target=null_resource.digest_server \
                          -auto-approve

echo "Deployment complete!"
